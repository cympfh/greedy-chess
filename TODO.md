# TODO.md

## ✅ Completed Core Features

### Core AI Algorithm
- [x] **Min-Max探索アルゴリズム実装**: 完全なmin-maxアルゴリズム実装済み（タイムアウト付き）
- [x] **反復深化探索**: 時間制限内で可能な限り深く探索する反復深化実装済み
- [x] **コマンドライン引数処理**: タイムアウトをコマンドライン引数から受け取る機能（デフォルト5秒）
- [x] **評価関数実装**: 駒の価値に基づく局面評価関数（P:1, N/B:3, R:5, Q:9, K:999）
- [x] **次の一手生成**: SAN形式でAIの指し手を出力 + コメント形式でボード表示
- [x] **キャッシュシステム**: 盤面状態とタイムアウトをキーにした結果キャッシュ
- [x] **オープニングブック**: 基本的なオープニングムーブのハードコーディング

### Legal Move Generation
- [x] **合法手生成**: 全駒種の完全な合法手生成システム実装
- [x] **チェック判定**: キングが攻撃されているかの判定機能
- [x] **チェックメイト/ステイルメイト判定**: ゲーム終了条件の検出機能
- [x] **ピン/スキュワー処理**: 自分のキングをチェックに晒す手の除外機能

### Move Validation Enhancement
- [x] **厳密なキャスリング条件**: 完全なキャスリング可能性チェック
  - [x] キング・ルークの移動履歴管理
  - [x] キングとルークの間が空いている
  - [x] キングが攻撃されていない
  - [x] 通過地点が攻撃されていない
  - [x] 到着地点が攻撃されていない
- [x] **アンパッサン条件**: 完全なen passant判定実装

## 🔴 High Priority Remaining Items

### Algorithm Improvements
- [x] **アルファベータ剪定**: Min-maxの高速化（現在はfull tree search） ✅ 実装完了
- [ ] **移動順序付け**: より効率的な探索のための手の順序付け（MVV-LVA等）
- [ ] **静止探索（Quiescence Search）**: 取り合いが続く局面での評価精度向上

### Chess Rules Compliance
- [ ] **三回同型局面**: 同じ局面が3回現れた場合の引き分け判定
- [ ] **50手ルール**: 駒取りやポーン移動がない状態での引き分け判定
- [ ] **不十分な駒による引き分け**: K vs K, KB vs K等の判定

## 🟡 Medium Priority Items

### Performance Optimization
- [ ] **探索の最適化**: 現在の実装は深い探索で時間がかかる可能性
- [ ] **評価関数の改善**: ポジション要素（中央制御、駒の活動性等）追加
- [ ] **メモリ使用量削減**: 不要なボードクローンの最適化

## 🟢 Enhancement Features

### User Interface
- [x] **SAN出力**: SAN形式での指し手出力実装済み + コメント形式ボード表示
- [ ] **PGN対応**: 完全なPGNファイル読み込み/出力
- [ ] **FEN対応**: FEN記法での局面入出力
- [ ] **対話モード**: 継続的に手を入力して対戦できるモード

### Advanced Features
- [x] **並列探索**: マルチスレッドでの探索高速化 ✅ 実装完了（-n オプション）
- [x] **開始局面データベース**: オープニングブック ✅ 実装済み
- [ ] **終盤データベース**: エンドゲームテーブルベース

## 🟢 Low Priority Items

### Code Quality
- [x] **未使用コード削除**: depth ベースのメソッド削除完了
- [ ] **エラー処理改善**: より詳細で親切なエラーメッセージ
- [ ] **テスト追加**: ユニットテストとインテグレーションテスト
- [ ] **ドキュメント**: 関数とモジュールのドキュメント化

### Configuration & Debugging
- [ ] **設定ファイル**: 評価パラメータの外部設定
- [ ] **ログ機能**: 探索過程の詳細ログ出力
- [ ] **デバッグモード**: 探索ツリーの可視化

### Code Organization
- [ ] **モジュール分割**: 大きなmain.rsを機能別モジュールに分割
- [ ] **型安全性**: newtype patternによる座標系の型安全化
- [ ] **エラー型**: カスタムエラー型の定義

## 📊 Current Status Summary

**✅ WORKING**: 実用的なチェスAIとして動作中
- 反復深化探索による時間管理
- キャッシュシステムによる高速化
- オープニングブック対応
- SAN形式での指し手出力 + ボード状態表示

**⚡ PERFORMANCE**:
- 反復深化により制限時間内で最適な探索深度を自動選択
- キャッシュにより同一局面の再計算を回避
- 典型的には深度5-7程度まで到達（5秒設定時）

**🎯 NEXT STEPS**: アルファベータ剪定の実装が最も効果的な改善項目

## Priority Order

1. **High Priority**: Alpha-Beta pruning, Move ordering
2. **Medium Priority**: Chess Rules Compliance, Evaluation improvements
3. **Low Priority**: Advanced Features, Code Quality improvements

## Recent Updates (2025-10-17)

- ✅ `--depth`オプションを削除し、`--timeout`ベースの探索に統一
- ✅ キャッシュキーから`depth`を削除し、`timeout`のみを使用
- ✅ 未使用の`minimax`と`find_best_move`（depth版）を削除
- ✅ 関数名から`_with_timeout`接尾辞を削除してリファクタリング
- ✅ **並列探索実装**: `-n/--threads`オプションで並列スレッド数を指定可能
- ✅ **Alpha-Beta剪定実装**: `minimax`を`alphabeta`に置き換え、探索効率が大幅向上
  - 探索深度が平均1段階向上（depth 3 → depth 4）
  - 並列探索との組み合わせで更なる高速化を実現
